<!-- public/booking.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Schedule Your Session</title>
  <style>
    :root { --bg:#0e0f12; --fg:#fff; --muted:#b9c0d0; --card:rgba(255,255,255,.06); --stroke:rgba(255,255,255,.14); --accent:#b7ffb2; --bad:#ffb4b4; }
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:720px;margin:0 auto;padding:24px 16px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:16px;padding:16px}
    h1{margin:0 0 6px 0;font-size:28px}
    p.note{margin:0 0 16px 0;color:var(--muted)}
    label{display:block;margin:.8rem 0 .3rem;font-weight:600}
    input,select,textarea{width:100%;padding:.65rem .75rem;border-radius:12px;border:1px solid var(--stroke);background:var(--bg);color:var(--fg)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
    button{margin-top:1rem;padding:.8rem 1rem;border-radius:12px;border:0;background:var(--accent);color:#0e0f12;font-weight:800;cursor:pointer}
    .msg{margin-top:.75rem}
    .ok{color:var(--accent)}
    .err{color:var(--bad)}
    .hint{color:var(--muted);font-size:12px;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Schedule your coaching session</h1>
    <p class="note">Thanks for your payment! Pick a date & time and add your details.</p>

    <div class="card">
      <!-- ✅ The form and all required elements/IDs -->
      <form id="bookingForm" novalidate>
        <label for="fullName">Full name</label>
        <input id="fullName" name="fullName" placeholder="Jane Doe" required />

        <div class="row">
          <div>
            <label for="email">Email</label>
            <input id="email" name="email" type="email" placeholder="jane@example.com" required />
          </div>
          <div>
            <label for="phone">Phone</label>
            <input id="phone" name="phone" placeholder="(555) 555-5555" required />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="date">Date</label>
            <input id="date" name="date" type="date" required />
          </div>
          <div>
            <label for="time">Time</label>
            <input id="time" name="time" type="time" required />
          </div>
        </div>

        <label for="duration">Duration</label>
        <select id="duration" name="duration">
          <option value="30">30 minutes</option>
          <option value="60" selected>60 minutes</option>
          <option value="90">90 minutes</option>
        </select>

        <label style="display:flex;gap:.5rem;align-items:center;margin-top:.8rem">
          <input id="inHome" type="checkbox" />
          <span>In-home session (we come to you)</span>
        </label>

        <div id="addressWrap" style="display:none">
          <label for="location">Home address</label>
          <input id="location" name="location" placeholder="Street, City" />
        </div>

        <label for="notes">Notes (optional)</label>
        <textarea id="notes" name="notes" rows="3" placeholder="Anything I should know?"></textarea>

        <button type="submit">Confirm booking</button>
        <div id="msg" class="msg"></div>
        <div class="hint">You’ll receive a calendar invite by email after confirmation.</div>
      </form>
    </div>
  </div>

  <!-- ✅ Script runs after DOM exists -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // --- helpers ---
    const qs = sel => document.querySelector(sel);
    const fmtLocalIso = (date) => {
      const pad = (n) => String(n).padStart(2, '0');
      return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
    };

    // --- session id from Stripe success redirect ---
    const params = new URLSearchParams(location.search);
    const session_id = params.get('session_id');
    if (!session_id) { location.replace('/'); return; }

    // --- inputs (now guaranteed to exist) ---
    const dateEl = qs('#date');
    const timeEl = qs('#time');
    const emailEl = qs('#email');
    const phoneEl = qs('#phone');
    const inHomeEl = qs('#inHome');
    const addressWrap = qs('#addressWrap');

    // min date & 15-min steps
    const today = new Date(); today.setHours(0,0,0,0);
    dateEl.min = today.toISOString().slice(0,10);
    timeEl.step = 60 * 15;

    // better input UX
    emailEl.setAttribute('autocomplete', 'email');
    phoneEl.setAttribute('inputmode', 'tel');

    // show/hide address
    inHomeEl.addEventListener('change', () => {
      addressWrap.style.display = inHomeEl.checked ? 'block' : 'none';
    });

    // API base (dev)
    const API_BASE_URL = 'http://localhost:3000';

    // form submit
    const formEl = qs('#bookingForm');
    const btnEl  = formEl.querySelector('button[type="submit"]');
    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      const msg = qs('#msg'); msg.textContent = ''; msg.className = 'msg';

      const fullName = qs('#fullName').value.trim();
      const email    = emailEl.value.trim();
      const phone    = phoneEl.value.trim();
      const date     = dateEl.value;
      const time     = timeEl.value;
      const duration = parseInt(qs('#duration').value || '60', 10) || 60;
      const inHome   = inHomeEl.checked;
      const location = inHome ? (qs('#location').value.trim() || 'Client address') : 'Urbarber Barbershop';
      const notes    = qs('#notes').value.trim();

      if (!fullName || !email || !phone || !date || !time) {
        msg.classList.add('err'); msg.textContent = 'Please complete all required fields.'; return;
      }

      const startLocal = new Date(`${date}T${time}:00`);
      const endLocal   = new Date(startLocal.getTime() + duration * 60000);
      const startStr   = fmtLocalIso(startLocal);
      const endStr     = fmtLocalIso(endLocal);

      const payload = { session_id, fullName, email, phone, start: startStr, end: endStr, inHome, location, notes };

      try {
        btnEl.disabled = true; btnEl.textContent = 'Confirming…';

        const res = await fetch(`${API_BASE_URL}/api/book`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // 'X-Booking-Key': 'YOUR_LONG_RANDOM_SECRET' // if using BOOKING_SECRET
          },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.ok) throw new Error(data.error || 'Booking failed. Please try again.');

        msg.classList.add('ok');
        msg.innerHTML = data.htmlLink
          ? 'Booking confirmed! Check your email for the invite. <br/><a style="color:#b7ffb2" target="_blank" rel="noopener" href="'+data.htmlLink+'">Open in Google Calendar</a>'
          : 'Booking confirmed! Check your email for the invite.';

        formEl.reset();
        addressWrap.style.display = 'none';
      } catch (err) {
        msg.classList.add('err'); msg.textContent = err.message;
      } finally {
        btnEl.disabled = false; btnEl.textContent = 'Confirm booking';
      }
    });
  });
  </script>
</body>
</html>
